#!/bin/bash

set -euo pipefail

# ANSI color codes and emoji for readability
GREEN=$(tput setaf 2)   # ğŸŸ¢
YELLOW=$(tput setaf 3)  # ğŸŸ¡
RESET=$(tput sgr0)      # ğŸ”„

# Function to display loading animation
function loading_animation() {
    local pid=$!
    local delay=0.15
    local spin='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '

    while ps -p $pid >/dev/null; do
        local temp=${spin#?}
        printf " [%c] " "$spin"
        local spin=$temp${spin%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done

    printf "    \b\b\b\b"
}

echo -n "${GREEN} ğŸŸ¢ Starting user setup...${RESET}"
sleep 1
echo -ne "\r${GREEN} âœ… Starting user setup...${RESET}"
sleep 1
echo -ne "\r${GREEN} ğŸŸ¢ Starting user setup...${RESET}"
sleep 1
echo -e "\r${GREEN} âœ… Starting user setup...${RESET}"

# Input validation
while true; do
    echo -n "${YELLOW} âš ï¸ Enter login (lowercase letters and numbers only): ${RESET}"
    read login
    if [[ $login =~ ^[a-z0-9]+$ ]]; then
        break
    else
        echo "${YELLOW}âŒ Invalid login. Please use only lowercase letters and numbers.${RESET}"
    fi
done

echo -n "${YELLOW} ğŸ”‘ Enter password: ${RESET}"
read -s password
echo

echo -n "${YELLOW} ğŸ—ï¸ Enter path of SSH public key: ${RESET}"
read ssh_pub_path

echo "${GREEN}ï¸ âš™ï¸ Creating user directories and setting up SSH...${RESET}"

homedir="/home/$login"     # ğŸ 
ssh_dir="$homedir/.ssh"    # ğŸ”’

# Create directories and set permissions securely
sudo mkdir -p "$ssh_dir"
sudo chmod 700 "$ssh_dir"  # ğŸ” Restrict access to owner only
sudo cat "$ssh_pub_path" >> "$ssh_dir/authorized_keys"
sudo chmod 600 "$ssh_dir/authorized_keys"  # ğŸ” Restrict access to owner only

# Create user with appropriate settings
sudo useradd -m -d "$homedir" -s /bin/bash -U "$login" &

# Set password securely
echo "$login:$password" | sudo chpasswd &

# Display loading animation
loading_animation

printf "\n${GREEN}âœ… User setup completed successfully!${RESET}\n"

# Check if user is successfully added
grep "$login" /etc/passwd

echo "${GREEN} ğŸ”§ Enjoy your new user account!${RESET}"
